// Prisma schema for Yoga & Wellness API

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum AccessLevel {
  FREE
  SUBSCRIPTION
}

enum ProgramSectionType {
  BENEFIT
  WHAT_YOU_NEED
  SAFETY_NOTE
}

enum VideoPrimaryCategory {
  YOGA
  BREATHING
  MEDITATION
  KNOWLEDGE
}

// Phase 3A.1: SubCategory enums
enum YogaSubCategory {
  WARM_UP
  MAIN_PRACTICE
  MOBILITY
  STRENGTH_STABILITY
  RESTORATIVE
  COOL_DOWN
}

enum BreathingSubCategory {
  CALMING
  BALANCING
  ENERGISING
}

enum MeditationSubCategory {
  GUIDED_RELAXATION
  BREATH_AWARENESS
  BODY_SCAN
  MINDFULNESS
  YOGA_NIDRA_SHORT
}

enum VideoLevel {
  BEGINNER
  INTERMEDIATE
  ALL_LEVELS
}

enum VideoIntensity {
  LOW
  MEDIUM
  HIGH
}

enum VideoStrengthDemand {
  VERY_LIGHT
  LIGHT
  MODERATE
  STRONG
}

enum ContentStatus {
  ACTIVE
  INACTIVE
}

// Phase 3A.1: New enums
enum SequenceRole {
  MANDATORY
  ADJUSTABLE
  OPTIONAL
}

enum DayType {
  GENTLE
  BUILD
  RESTORE
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum SubscriptionTier {
  FREE
  PAID
}

enum EventStatus {
  PROCESSED
  IGNORED
  FAILED
}

// ============================================
// MODELS
// ============================================

model User {
  id          String    @id @default(uuid()) @db.Uuid
  firebaseUid String    @unique
  phone       String?
  email       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Profile fields
  name     String?
  age      Int?
  gender   String? // "male" | "female" | "other" | "prefer_not_to_say"
  heightCm Int?
  weightKg Int?

  // Onboarding selections
  wellnessFocusId String? // Single wellness focus ID
  primaryGoalId   String? // Single primary goal ID
  preferencesJson Json?   // {sessionLength, preferredTime, experienceLevel}

  // Onboarding tracking
  isOnboardingComplete  Boolean   @default(false)
  onboardingCompletedAt DateTime?

  // Relations
  favoritePrograms      UserFavoriteProgram[]
  practicePreferences   PracticePreferences?
  abhyasaCycles         AbhyasaCycle[]
  programEnrollments    UserProgramEnrollment[]
  subscription          UserSubscription?
  subscriptionEvents    UserSubscriptionEvent[]

  @@map("users")
}

model ProgramTemplate {
  id                     String        @id @default(uuid()) @db.Uuid
  title                  String
  sanskritTitle          String?
  subtitle               String?
  descriptionShort       String?
  heroImageKey           String        // R2 key for hero image
  defaultDays            Int
  defaultMinutesPerDay   Int
  levelLabel             String?
  accessLevel            AccessLevel
  requiredEntitlementKey String?
  status                 ContentStatus
  version                Int           @default(1)
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  // Phase 3A.1: Required fields
  benefits             Json        // Array of benefit strings
  whatYouNeed          Json?       // Array of what you need strings
  safetyNotes          Json?       // Array of safety note strings
  primaryGoal          String      // Primary goal for matching
  focusArea            String      // Focus area
  recommendedLevel     VideoLevel  // Recommended level enum
  categoryRecipe       Json        // e.g., {"Yoga": "Mandatory", "Breathing": "Adjustable", "Meditation": "Optional"}
  libraryRhythm        Json        // e.g., {"pattern": [6, 1], "types": ["gentle", "restore"]}

  // Relations
  sections            ProgramTemplateSection[]
  days                ProgramDay[]
  tags                ProgramTemplateTag[]
  favoritedByUsers    UserFavoriteProgram[]
  librarySchedule     LibraryProgramSchedule?
  abhyasaCycles       AbhyasaCycle[]
  enrollments         UserProgramEnrollment[]

  @@index([status])
  @@index([accessLevel])
  @@map("program_templates")
}

model ProgramTemplateSection {
  id                String             @id @default(uuid()) @db.Uuid
  programTemplateId String             @db.Uuid
  type              ProgramSectionType
  sortOrder         Int
  text              String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  programTemplate ProgramTemplate @relation(fields: [programTemplateId], references: [id], onDelete: Cascade)

  @@index([programTemplateId, type, sortOrder])
  @@map("program_template_sections")
}

model ProgramDay {
  id                String   @id @default(uuid()) @db.Uuid
  programTemplateId String   @db.Uuid
  dayNumber         Int
  title             String?
  intent            String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  programTemplate ProgramTemplate  @relation(fields: [programTemplateId], references: [id], onDelete: Cascade)
  items           ProgramDayItem[]

  @@unique([programTemplateId, dayNumber])
  @@map("program_days")
}

model ProgramDayItem {
  id           String   @id @default(uuid()) @db.Uuid
  programDayId String   @db.Uuid
  orderIndex   Int
  videoId      String   @db.Uuid
  sequenceRole String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  programDay ProgramDay @relation(fields: [programDayId], references: [id], onDelete: Cascade)
  video      Video      @relation(fields: [videoId], references: [id], onDelete: Restrict)

  @@unique([programDayId, orderIndex])
  @@index([programDayId])
  @@map("program_day_items")
}

model Video {
  id                     String               @id @default(uuid()) @db.Uuid
  name                   String
  descriptionShort       String?
  primaryCategory        VideoPrimaryCategory
  durationSec            Int
  level                  VideoLevel
  intensity              VideoIntensity
  strengthDemand         VideoStrengthDemand
  accessLevel            AccessLevel
  requiredEntitlementKey String?
  cloudflareStreamUid    String?
  thumbnailR2Key         String?
  status                 ContentStatus
  version                Int                  @default(1)
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt

  tags                 VideoTag[]
  referencedInDayItems ProgramDayItem[]

  @@index([primaryCategory])
  @@index([status])
  @@index([accessLevel])
  @@map("videos")
}

// Phase 3A.1: New VideoAsset model (atomic video unit)
model VideoAsset {
  id                  String               @id @default(uuid()) @db.Uuid
  name                String
  shortDescription    String
  thumbnailKey        String               // R2 key (not full URL)
  streamUid           String               // Cloudflare Stream UID (not full URL)
  primaryCategory     VideoPrimaryCategory
  yogaSubCategory     YogaSubCategory?
  breathingSubCategory BreathingSubCategory?
  meditationSubCategory MeditationSubCategory?
  level               VideoLevel
  intensity           VideoIntensity
  strengthDemand      VideoStrengthDemand
  focusAreas          Json                 // Array of focus areas
  goals               Json                 // Array of goals
  sequenceRole        SequenceRole
  durationSec         Int
  caloriesPerMin      Float?
  contraIndications   Json?                // Optional array of contraindications
  status              ContentStatus
  version             String
  tags                Json?                // Optional array of tag strings
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  // Relations
  playlistItems       PlaylistItem[]

  @@index([primaryCategory])
  @@index([status])
  @@index([sequenceRole])
  @@map("video_assets")
}

// Phase 3A.1: LibraryProgramSchedule (cached schedule for ProgramTemplate)
model LibraryProgramSchedule {
  id                    String   @id @default(uuid()) @db.Uuid
  programTemplateId     String   @unique @db.Uuid
  generatedFromVersion  String?
  days                  Json     // Array of {dayNumber, dayType, playlist[], totalDurationSec}
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  programTemplate ProgramTemplate @relation(fields: [programTemplateId], references: [id], onDelete: Cascade)

  @@map("library_program_schedules")
}

// Phase 3A.1: PracticePreferences (user profile settings)
model PracticePreferences {
  userId            String   @id @db.Uuid
  focusArea         String
  primaryGoal       String
  level             VideoLevel
  minutesPreference Int      // 10, 20, or 30
  preferredTime     String?  // "morning" or "evening"
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("practice_preferences")
}

// Phase 3A.1: AbhyasaCycle (user personalized 21-day plan)
model AbhyasaCycle {
  id                  String   @id @default(uuid()) @db.Uuid
  userId              String   @db.Uuid
  programTemplateId   String   @db.Uuid
  startDate           DateTime
  cycleDays           Int      @default(21)
  minutesPreference   Int
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  programTemplate ProgramTemplate   @relation(fields: [programTemplateId], references: [id], onDelete: Cascade)
  dayPlans        AbhyasaDayPlan[]

  @@index([userId])
  @@index([programTemplateId])
  @@map("abhyasa_cycles")
}

// Phase 3A.1: AbhyasaDayPlan (one day inside AbhyasaCycle)
model AbhyasaDayPlan {
  id               String   @id @default(uuid()) @db.Uuid
  abhyasaCycleId   String   @db.Uuid
  dayNumber        Int
  dayType          DayType
  totalDurationSec Int
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  abhyasaCycle  AbhyasaCycle   @relation(fields: [abhyasaCycleId], references: [id], onDelete: Cascade)
  playlistItems PlaylistItem[]

  @@index([abhyasaCycleId])
  @@map("abhyasa_day_plans")
}

// Phase 3A.1: PlaylistItem (one video inside a day playlist)
model PlaylistItem {
  id                  String                  @id @default(uuid()) @db.Uuid
  abhyasaDayPlanId    String?                 @db.Uuid // For Abhyasa day playlists
  videoAssetId        String                  @db.Uuid
  primaryCategory     VideoPrimaryCategory
  yogaSubCategory     YogaSubCategory?
  breathingSubCategory BreathingSubCategory?
  meditationSubCategory MeditationSubCategory?
  sequenceRole        SequenceRole
  durationSec         Int
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt

  abhyasaDayPlan AbhyasaDayPlan? @relation(fields: [abhyasaDayPlanId], references: [id], onDelete: Cascade)
  videoAsset     VideoAsset      @relation(fields: [videoAssetId], references: [id], onDelete: Restrict)

  @@index([abhyasaDayPlanId])
  @@index([videoAssetId])
  @@map("playlist_items")
}

// Phase 3A.1: UserProgramEnrollment (for subscription gating)
model UserProgramEnrollment {
  id                String           @id @default(uuid()) @db.Uuid
  userId            String           @db.Uuid
  programTemplateId String           @db.Uuid
  status            EnrollmentStatus
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  programTemplate ProgramTemplate @relation(fields: [programTemplateId], references: [id], onDelete: Cascade)

  @@unique([userId, programTemplateId])
  @@index([userId])
  @@index([programTemplateId])
  @@map("user_program_enrollments")
}

// Phase 3A.1: UserSubscription (for RevenueCat sync)
model UserSubscription {
  userId         String            @id @db.Uuid
  tier           SubscriptionTier
  entitlement    String            // e.g., "pro"
  isActive       Boolean
  expiresAt      DateTime?
  store          String?
  productId      String?
  environment    String?
  latestEventAt  DateTime?
  rawRcPayload   Json?             // Raw RevenueCat payload
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_subscriptions")
}

// Phase 3A.1: UserSubscriptionEvent (for RevenueCat webhook events)
model UserSubscriptionEvent {
  id          String      @id @default(uuid()) @db.Uuid
  userId      String      @db.Uuid
  eventType   String
  occurredAt  DateTime
  payload     Json
  status      EventStatus
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([eventType])
  @@index([occurredAt])
  @@map("user_subscription_events")
}

model TagType {
  id        String   @id @default(uuid()) @db.Uuid
  code      String   @unique
  label     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tags Tag[]

  @@map("tag_types")
}

model Tag {
  id          String   @id @default(uuid()) @db.Uuid
  tagTypeId   String   @db.Uuid
  code        String
  label       String
  parentTagId String?  @map("parent_tag_id") @db.Uuid // Optional: for hierarchical relationships (e.g., goals â†’ wellness focus)
  sortOrder   Int?     @map("sort_order") // Admin-friendly: control display order
  isActive    Boolean  @default(true) @map("is_active") // Admin-friendly: soft delete / enable-disable
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tagType      TagType              @relation(fields: [tagTypeId], references: [id], onDelete: Cascade)
  parent       Tag?                 @relation("TagHierarchy", fields: [parentTagId], references: [id], onDelete: SetNull)
  children     Tag[]                @relation("TagHierarchy")
  videoTags    VideoTag[]
  programTags  ProgramTemplateTag[]

  @@unique([tagTypeId, code])
  @@index([tagTypeId])
  @@index([parentTagId])
  @@index([isActive])
  @@map("tags")
}

model VideoTag {
  id        String   @id @default(uuid()) @db.Uuid
  videoId   String   @db.Uuid
  tagId     String   @db.Uuid
  createdAt DateTime @default(now())

  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)
  tag   Tag   @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([videoId, tagId])
  @@index([videoId])
  @@index([tagId])
  @@map("video_tags")
}

model ProgramTemplateTag {
  id                String   @id @default(uuid()) @db.Uuid
  programTemplateId String   @db.Uuid
  tagId             String   @db.Uuid
  createdAt         DateTime @default(now())

  programTemplate ProgramTemplate @relation(fields: [programTemplateId], references: [id], onDelete: Cascade)
  tag             Tag             @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([programTemplateId, tagId])
  @@index([programTemplateId])
  @@index([tagId])
  @@map("program_template_tags")
}

model Language {
  id        String   @id @default(uuid()) @db.Uuid
  code      String   @unique
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("languages")
}

model EntityTranslation {
  id           String   @id @default(uuid()) @db.Uuid
  entityType   String
  entityId     String
  field        String
  languageCode String
  value        String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([entityType, entityId, field, languageCode])
  @@index([entityType, entityId])
  @@index([languageCode])
  @@map("entity_translations")
}

model UserFavoriteProgram {
  id                String   @id @default(uuid()) @db.Uuid
  userId            String   @db.Uuid
  programTemplateId String   @db.Uuid
  createdAt         DateTime @default(now())

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  programTemplate ProgramTemplate @relation(fields: [programTemplateId], references: [id], onDelete: Cascade)

  @@unique([userId, programTemplateId])
  @@index([userId])
  @@index([programTemplateId])
  @@map("user_favorite_programs")
}
